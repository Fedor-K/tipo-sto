# ДЕТАЛЬНЫЙ ПЛАН ПЕРЕНОСА 185.222 → Rent1C

## 1. МАСШТАБ ЗАДАЧИ

### Справочники (Catalogs)
| Объект | Записей | Приоритет | Зависимости |
|--------|---------|-----------|-------------|
| Организации | 4 | 1 | - |
| Валюты | ~3 | 1 | - |
| ЕдиницыИзмерения | ~100 | 1 | - |
| СтавкиНДС | ~5 | 1 | - |
| ТипыЦен | ~6 | 1 | Валюты |
| Цеха | 6 | 1 | Организации |
| ПодразделенияКомпании | ~10 | 1 | Организации |
| СкладыКомпании | ~10 | 1 | Организации, Подразделения |
| ВидыРемонта | ~5 | 2 | - |
| ВидыСостоянийЗаказНарядов | ~10 | 2 | - |
| Должности | ~20 | 2 | - |
| Цвета | ~50 | 2 | - |
| Модели | ~500 | 2 | - |
| ТипыКузовов | ~20 | 2 | - |
| ТипыДвигателей | ~10 | 2 | - |
| ТипыКПП | ~5 | 2 | - |
| Сотрудники | 66 | 3 | Должности, Подразделения |
| Контрагенты | 7,675 | 3 | - |
| Автомобили | 8,288 | 4 | Контрагенты, Модели, Цвета |
| ДоговорыВзаиморасчетов | 12,419 | 4 | Контрагенты, Организации, Валюты |
| Автоработы | 2,935 | 3 | ЕдиницыИзмерения |
| **Номенклатура** | **679,249** | 3 | ЕдиницыИзмерения, СтавкиНДС |
| Нормочасы | ~100 | 3 | - |

**Итого справочники: ~710,000 записей**

### Документы (Documents)
| Объект | Записей | Табл.части | Зависимости |
|--------|---------|------------|-------------|
| **ЗаказНаряд** | **27,954** | 5 | Все справочники |
| РеализацияТоваров | 27,130 | 2 | Контрагенты, Номенклатура |
| ПоступлениеТоваров | 41,987 | 2 | Контрагенты, Номенклатура |
| ПриходныйКассовыйОрдер | ~5,000 | 1 | Контрагенты |
| РасходныйКассовыйОрдер | ~3,000 | 1 | Контрагенты |

**Итого документы: ~105,000 записей**

### ВСЕГО: ~815,000 записей

---

## 2. ПОРЯДОК ПЕРЕНОСА (Dependency Order)

### ЭТАП 1: Базовые справочники (без зависимостей)
```
1.1  Валюты
1.2  ЕдиницыИзмерения
1.3  СтавкиНДС
1.4  Организации
1.5  Цвета
1.6  Модели
1.7  ТипыКузовов
1.8  ТипыДвигателей
1.9  ТипыКПП
1.10 ВидыРемонта
1.11 ВидыСостоянийЗаказНарядов
1.12 Должности
1.13 Нормочасы
```

### ЭТАП 2: Справочники с простыми зависимостями
```
2.1  ТипыЦен              → Валюты
2.2  Цеха                 → Организации
2.3  ПодразделенияКомпании → Организации
2.4  СкладыКомпании       → Организации, Подразделения
2.5  Сотрудники           → Должности, Подразделения
2.6  Автоработы           → ЕдиницыИзмерения
```

### ЭТАП 3: Основные справочники
```
3.1  Контрагенты          → (независимый)
3.2  Номенклатура         → ЕдиницыИзмерения, СтавкиНДС (679K записей!)
```

### ЭТАП 4: Справочники с ссылками на Контрагентов
```
4.1  Автомобили           → Контрагенты (Поставщик), Модели, Цвета
4.2  ДоговорыВзаиморасчетов → Контрагенты (Owner), Организации, Валюты
```

### ЭТАП 5: Документы
```
5.1  ЗаказНаряд           → ВСЕ справочники + табличные части
5.2  РеализацияТоваров    → Контрагенты, Номенклатура
5.3  ПоступлениеТоваров   → Контрагенты, Номенклатура
5.4  ПриходныйКассовыйОрдер
5.5  РасходныйКассовыйОрдер
```

---

## 3. СТРУКТУРА ЗАКАЗ-НАРЯДА (детально)

### Шапка документа (71 поле)
**Обязательные ссылки:**
- Организация_Key
- Контрагент_Key
- Автомобиль_Key
- ДоговорВзаиморасчетов_Key
- Цех_Key
- Мастер_Key (Сотрудники)
- ТипЦен_Key
- ТипЦенРабот_Key
- ВидРемонта_Key
- Состояние_Key
- ВалютаДокумента_Key
- Автор_Key (Пользователи)

### Табличные части

#### Работы (25 полей на строку)
```
- Работа → Автоработы
- Количество
- Цена
- Сумма
- СтавкаНДС → СтавкиНДС
- Исполнитель → Сотрудники
- Цех → Цеха
- НормаВремени
- ВремяВыполнения
...
```

#### Товары (24 поля на строку)
```
- Номенклатура → Номенклатура
- Количество
- ЕдиницаИзмерения → ЕдиницыИзмерения
- Цена
- Сумма
- СтавкаНДС → СтавкиНДС
- Склад → СкладыКомпании
- Качество
...
```

#### Исполнители (4 поля)
```
- Исполнитель → Сотрудники
- Цех → Цеха
- ИдентификаторРаботы
- ДоляВыработки
```

#### Материалы (9 полей)
```
- Номенклатура → Номенклатура
- Количество
- ЕдиницаИзмерения
...
```

#### МатериалыЗаказчика (7 полей)
```
- Номенклатура → Номенклатура
- Количество
...
```

---

## 4. ТАБЛИЦА МАППИНГА REF_KEY

При переносе КАЖДОЙ записи нужно сохранять соответствие:

```
mapping_table = {
    "Catalog_Организации": {
        "old_guid_185": "new_guid_rent1c",
        ...
    },
    "Catalog_Контрагенты": {
        "old_guid_185": "new_guid_rent1c",
        ...
    },
    ...
}
```

**Размер таблицы маппинга: ~710,000 записей**

---

## 5. АЛГОРИТМ ПЕРЕНОСА

### 5.1 Перенос справочника
```python
def transfer_catalog(catalog_name, dependencies):
    # 1. Получить все записи из 185.222
    records = get_all_from_source(catalog_name)

    # 2. Для каждой записи
    for record in records:
        # 3. Заменить все Ref_Key на новые из маппинга
        for field in record:
            if is_ref_field(field):
                old_ref = record[field]
                new_ref = mapping[field_type][old_ref]
                record[field] = new_ref

        # 4. Создать в Rent1C
        new_ref = create_in_rent1c(catalog_name, record)

        # 5. Сохранить маппинг
        mapping[catalog_name][record['Ref_Key']] = new_ref
```

### 5.2 Перенос документа с табличными частями
```python
def transfer_document(doc_name, record):
    # 1. Подготовить шапку с заменой ссылок
    header = prepare_header(record, mapping)

    # 2. Подготовить табличные части
    tabular_parts = {}
    for tp_name in ['Товары', 'Работы', 'Исполнители', ...]:
        rows = get_tabular_part(record, tp_name)
        tabular_parts[tp_name] = []
        for row in rows:
            new_row = replace_refs_in_row(row, mapping)
            tabular_parts[tp_name].append(new_row)

    # 3. Создать документ с табличными частями
    create_document_with_tabular(header, tabular_parts)
```

---

## 6. ОЦЕНКА ВРЕМЕНИ

### При скорости 10 записей/сек через OData:

| Этап | Записей | Время |
|------|---------|-------|
| Этап 1 (базовые) | ~800 | 1.5 мин |
| Этап 2 (зависимые) | ~200 | 0.5 мин |
| Этап 3 (основные) | 687,000 | **19 часов** |
| Этап 4 (связанные) | 20,700 | 35 мин |
| Этап 5 (документы) | 105,000 | **3 часа** |

**ИТОГО: ~23 часа непрерывной работы**

### Оптимизация:
- Batch-запросы (если поддерживаются)
- Параллельные потоки
- Прямая загрузка в 1С (без OData)

---

## 7. РИСКИ И ОГРАНИЧЕНИЯ

### 7.1 OData ограничения
- Не все поля могут быть записаны
- Табличные части могут не поддерживаться
- Лимиты на размер запроса
- Таймауты

### 7.2 Целостность данных
- Битые ссылки в исходной базе
- Дубликаты кодов
- Невалидные даты

### 7.3 Бизнес-логика
- Проведение документов
- Нумерация документов
- Права доступа

---

## 8. РЕКОМЕНДАЦИИ

### Вариант A: Полный перенос через OData (сложно)
- Время: ~23 часа
- Код: ~2000 строк Python
- Риски: высокие

### Вариант B: Только справочники через OData
- Время: ~20 часов (из-за Номенклатуры)
- Код: ~500 строк Python
- Риски: средние
- Документы создаются заново

### Вариант C: Выгрузка/Загрузка через 1С
- Использовать типовую обработку "Выгрузка/Загрузка данных XML"
- Или "Конвертация данных 3.0"
- Время: ~2-4 часа
- Риски: низкие

### Вариант D: Копирование базы
- Если Rent1C позволяет загрузить .dt файл
- Время: ~30 минут
- Риски: низкие

---

## 9. МОЯ РЕКОМЕНДАЦИЯ

**Вариант C** - использовать стандартные механизмы 1С:

1. Выгрузить данные из 185.222 в XML через конфигуратор
2. Загрузить XML в Rent1C
3. Это стандартный, проверенный способ миграции

Если нужен именно OData - готов реализовать, но это займёт много времени и кода.
