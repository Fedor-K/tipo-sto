<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>TIPO-STO Demo v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f5; }

        .app { display: flex; min-height: 100vh; }

        /* Sidebar */
        .sidebar { width: 200px; background: #1a1a2e; color: white; padding: 20px 10px; }
        .logo { font-size: 18px; font-weight: bold; padding: 10px; margin-bottom: 20px; }
        .nav-item { padding: 12px 15px; color: #aaa; border-radius: 6px; cursor: pointer; margin: 2px 0; }
        .nav-item:hover { background: #333; color: white; }
        .nav-item.active { background: #4CAF50; color: white; }

        /* Main */
        .main { flex: 1; padding: 20px; }

        /* Header */
        .page-header { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .page-header h1 { font-size: 20px; }
        .back-btn { padding: 8px 15px; background: #eee; border: none; border-radius: 6px; cursor: pointer; }

        /* Card */
        .card { background: white; border-radius: 10px; padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card-title { font-size: 14px; font-weight: 600; color: #333; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

        /* Form */
        .form-row { display: flex; gap: 15px; margin-bottom: 15px; }
        .form-group { flex: 1; }
        .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 5px; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;
        }

        /* Buttons */
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #eee; color: #333; }

        /* Table */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f9f9f9; font-size: 12px; color: #666; }

        /* Client item */
        .client-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; }
        .client-item:hover { background: #f9f9f9; }
        .client-avatar { width: 40px; height: 40px; background: #4CAF50; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 15px; }
        .client-name { font-weight: 600; }
        .client-info { font-size: 12px; color: #888; }

        /* Stats */
        .stats { display: flex; gap: 30px; margin: 20px 0; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; color: #888; }

        /* Car item */
        .car-item { display: flex; align-items: center; padding: 12px; border: 1px solid #eee; border-radius: 8px; margin-bottom: 10px; cursor: pointer; }
        .car-item:hover { border-color: #4CAF50; }
        .car-item.selected { border-color: #4CAF50; background: #e8f5e9; }

        /* Order item */
        .order-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .order-num { width: 100px; font-weight: 600; color: #4CAF50; }
        .order-desc { flex: 1; }
        .order-sum { width: 100px; text-align: right; font-weight: 600; }

        /* Modal */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; }
        .modal.open { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; border-radius: 10px; width: 500px; max-height: 80vh; overflow: auto; }
        .modal-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
        .modal-body { padding: 20px; max-height: 400px; overflow: auto; }

        /* List item in modal */
        .list-item { padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .list-item:hover { background: #f5f5f5; }

        /* Actions */
        .actions { display: flex; gap: 10px; padding: 20px; background: #f9f9f9; border-radius: 0 0 10px 10px; margin: -20px; margin-top: 20px; }
        .spacer { flex: 1; }

        /* Summary */
        .summary { display: flex; justify-content: flex-end; gap: 30px; padding: 15px 0; }
        .summary-label { font-size: 12px; color: #888; }
        .summary-value { font-size: 18px; font-weight: bold; }
        .summary-value.total { color: #4CAF50; }

        .hidden { display: none !important; }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <div class="logo">TIPO-STO</div>
            <div class="nav-item" onclick="showPage('clients')">üë• –ö–ª–∏–µ–Ω—Ç—ã</div>
            <div class="nav-item active" onclick="showPage('orders')">üìã –ó–∞–∫–∞–∑—ã</div>
        </div>

        <div class="main">
            <!-- Page: Orders List -->
            <div id="page-orders">
                <div class="page-header">
                    <h1>–ó–∞–∫–∞–∑-–Ω–∞—Ä—è–¥—ã</h1>
                    <input type="text" placeholder="üîç –ü–æ–∏—Å–∫..." style="padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 6px;" oninput="filterOrders(this.value)">
                    <button class="btn btn-primary" onclick="showPage('clients')">+ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
                </div>
                <div class="card">
                    <div id="orders-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Page: Clients List -->
            <div id="page-clients" class="hidden">
                <div class="page-header">
                    <h1>–ö–ª–∏–µ–Ω—Ç—ã</h1>
                    <input type="text" placeholder="üîç –ü–æ–∏—Å–∫..." style="padding: 10px; width: 300px; border: 1px solid #ddd; border-radius: 6px;" oninput="filterClients(this.value)">
                </div>
                <div class="card">
                    <div id="clients-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Page: Client Card -->
            <div id="page-client" class="hidden">
                <div class="page-header">
                    <button class="back-btn" onclick="showPage('clients')">‚Üê –ù–∞–∑–∞–¥</button>
                    <h1 id="client-title">–ö–ª–∏–µ–Ω—Ç</h1>
                    <div class="spacer"></div>
                    <button class="btn btn-primary" onclick="showPage('new-order')">+ –ù–æ–≤—ã–π –∑–∞–∫–∞–∑</button>
                </div>

                <div class="card">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <div class="client-avatar" style="width: 60px; height: 60px; font-size: 24px;" id="client-avatar">?</div>
                        <div>
                            <div style="font-size: 20px; font-weight: 600;" id="client-name">‚Äî</div>
                            <div style="color: #888;" id="client-type">‚Äî</div>
                        </div>
                    </div>
                    <div class="stats">
                        <div><div class="stat-value" id="stat-orders">0</div><div class="stat-label">–í–∏–∑–∏—Ç–æ–≤</div></div>
                        <div><div class="stat-value" id="stat-sum">0 ‚ÇΩ</div><div class="stat-label">–°—É–º–º–∞</div></div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="card">
                        <div class="card-title">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª–∏</div>
                        <div id="client-cars">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <div class="card">
                        <div class="card-title">üìù –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                        <div><strong>–ò–ù–ù:</strong> <span id="client-inn">‚Äî</span></div>
                        <div style="margin-top: 10px;"><strong>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</strong> <span id="client-comment">‚Äî</span></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">üìã –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
                    <div id="client-orders">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                </div>
            </div>

            <!-- Page: New Order -->
            <div id="page-new-order" class="hidden">
                <div class="page-header">
                    <button class="back-btn" onclick="showPage('client')">‚Üê –ù–∞–∑–∞–¥</button>
                    <h1>–ù–æ–≤—ã–π –∑–∞–∫–∞–∑-–Ω–∞—Ä—è–¥</h1>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="card">
                        <div class="card-title">üë§ –ö–ª–∏–µ–Ω—Ç</div>
                        <div id="order-client-info" style="padding: 10px; background: #f5f5f5; border-radius: 6px;">
                            –ù–µ –≤—ã–±—Ä–∞–Ω
                        </div>
                        <div class="card-title" style="margin-top: 20px;">üöó –ê–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                        <div id="order-cars">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤—Ç–æ–º–æ–±–∏–ª—å</div>
                        <input type="hidden" id="selected-car-key">
                    </div>

                    <div class="card">
                        <div class="card-title">üìù –î–∞–Ω–Ω—ã–µ –∑–∞–∫–∞–∑–∞</div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–í–∏–¥ —Ä–µ–º–æ–Ω—Ç–∞</label>
                                <select id="order-repair-type"><option>‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>
                            </div>
                            <div class="form-group">
                                <label>–¶–µ—Ö</label>
                                <select id="order-workshop"><option>‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>–ü—Ä–æ–±–µ–≥ (–∫–º)</label>
                                <input type="number" id="order-mileage" placeholder="0">
                            </div>
                            <div class="form-group">
                                <label>–ú–∞—Å—Ç–µ—Ä</label>
                                <select id="order-master"><option>‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>–ü—Ä–∏—á–∏–Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è</label>
                            <textarea id="order-reason" rows="2"></textarea>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between;">
                        üîß –†–∞–±–æ—Ç—ã
                        <button class="btn btn-primary" onclick="openModal('works')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <table>
                        <thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
                        <tbody id="works-table"><tr><td colspan="6" style="text-align: center; color: #888;">–î–æ–±–∞–≤—å—Ç–µ —Ä–∞–±–æ—Ç—ã</td></tr></tbody>
                    </table>
                    <div class="summary">
                        <div><div class="summary-label">–ò—Ç–æ–≥–æ —Ä–∞–±–æ—Ç—ã</div><div class="summary-value" id="works-sum">0 ‚ÇΩ</div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title" style="display: flex; justify-content: space-between;">
                        üì¶ –ó–∞–ø—á–∞—Å—Ç–∏
                        <button class="btn btn-primary" onclick="openModal('parts')">+ –î–æ–±–∞–≤–∏—Ç—å</button>
                    </div>
                    <table>
                        <thead><tr><th>‚Ññ</th><th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞</th><th>–°–∫–∏–¥–∫–∞</th><th>–°—É–º–º–∞</th><th></th></tr></thead>
                        <tbody id="parts-table"><tr><td colspan="7" style="text-align: center; color: #888;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—á–∞—Å—Ç–∏</td></tr></tbody>
                    </table>
                    <div class="summary">
                        <div><div class="summary-label">–ò—Ç–æ–≥–æ –∑–∞–ø—á–∞—Å—Ç–∏</div><div class="summary-value" id="parts-sum">0 ‚ÇΩ</div></div>
                    </div>
                </div>

                <div class="card">
                    <div class="summary">
                        <div><div class="summary-label">–†–∞–±–æ—Ç—ã</div><div class="summary-value" id="total-works">0 ‚ÇΩ</div></div>
                        <div><div class="summary-label">–ó–∞–ø—á–∞—Å—Ç–∏</div><div class="summary-value" id="total-parts">0 ‚ÇΩ</div></div>
                        <div><div class="summary-label">–ò–¢–û–ì–û</div><div class="summary-value total" id="total-sum">0 ‚ÇΩ</div></div>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" onclick="showPage('client')">–û—Ç–º–µ–Ω–∞</button>
                        <div class="spacer"></div>
                        <button class="btn btn-primary" onclick="saveOrder()">‚úì –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Works -->
    <div id="modal-works" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <strong>–í—ã–±–æ—Ä —Ä–∞–±–æ—Ç—ã</strong>
                <button onclick="closeModal('works')" style="border:none;background:none;font-size:18px;cursor:pointer;">‚úï</button>
            </div>
            <div style="padding: 10px 20px;"><input type="text" placeholder="–ü–æ–∏—Å–∫..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterWorks(this.value)"></div>
            <div class="modal-body" id="works-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- Modal: Car Select -->
    <div id="modal-car-select" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <strong>–í—ã–±–æ—Ä –∞–≤—Ç–æ–º–æ–±–∏–ª—è</strong>
                <button onclick="closeModal('car-select')" style="border:none;background:none;font-size:18px;cursor:pointer;">‚úï</button>
            </div>
            <div style="padding: 10px 20px;"><input type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ VIN –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterCarSelect(this.value)"></div>
            <div class="modal-body" id="car-select-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <!-- Modal: Parts -->
    <div id="modal-parts" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <strong>–í—ã–±–æ—Ä –∑–∞–ø—á–∞—Å—Ç–∏</strong>
                <button onclick="closeModal('parts')" style="border:none;background:none;font-size:18px;cursor:pointer;">‚úï</button>
            </div>
            <div style="padding: 10px 20px;"><input type="text" placeholder="–ü–æ–∏—Å–∫..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;" oninput="filterParts(this.value)"></div>
            <div class="modal-body" id="parts-list">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
    </div>

    <script>
        // ===== STATE =====
        let allClients = [];
        let allWorks = [];
        let allParts = [];
        let currentClient = null;
        let orderWorks = [];
        let orderParts = [];

        // ===== PAGES =====
        function showPage(name) {
            console.log('showPage:', name);
            document.getElementById('page-orders').classList.add('hidden');
            document.getElementById('page-clients').classList.add('hidden');
            document.getElementById('page-client').classList.add('hidden');
            document.getElementById('page-new-order').classList.add('hidden');

            if (name === 'orders') {
                document.getElementById('page-orders').classList.remove('hidden');
                loadOrders();
            } else if (name === 'clients') {
                document.getElementById('page-clients').classList.remove('hidden');
            } else if (name === 'client') {
                document.getElementById('page-client').classList.remove('hidden');
            } else if (name === 'new-order') {
                document.getElementById('page-new-order').classList.remove('hidden');
                setupNewOrder();
            }
        }

        // ===== ORDERS =====
        let allOrders = [];

        async function loadOrders() {
            const container = document.getElementById('orders-list');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            try {
                const resp = await fetch('/proxy/odata/Document_–ó–∞–∫–∞–∑–ù–∞—Ä—è–¥?$top=50&$orderby=Date desc&$format=json');
                const data = await resp.json();
                allOrders = data.value || [];

                // Load client names
                const clientKeys = [...new Set(allOrders.map(o => o.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_Key).filter(k => k && k !== '00000000-0000-0000-0000-000000000000'))];
                const clientsMap = {};
                if (clientKeys.length > 0) {
                    const filter = clientKeys.slice(0, 20).map(k => `Ref_Key eq guid'${k}'`).join(' or ');
                    const clientsResp = await fetch(`/proxy/odata/Catalog_–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã?$filter=${encodeURIComponent(filter)}&$format=json`);
                    const clientsData = await clientsResp.json();
                    (clientsData.value || []).forEach(c => clientsMap[c.Ref_Key] = c.Description);
                }

                renderOrders(allOrders, clientsMap);
            } catch (e) {
                container.innerHTML = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        function renderOrders(orders, clientsMap = {}) {
            const container = document.getElementById('orders-list');
            if (!orders.length) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                return;
            }
            container.innerHTML = orders.map(o => {
                const sum = (o.–°—É–º–º–∞–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0) + (o.–°—É–º–º–∞–†–∞–±–æ—Ç–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0);
                const clientName = clientsMap[o.–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_Key] || '‚Äî';
                const date = new Date(o.Date).toLocaleDateString('ru-RU');
                return `
                    <div class="order-item" onclick="openOrder('${o.Ref_Key}')">
                        <div class="order-num">‚Ññ${(o.Number || '').trim()}</div>
                        <div style="width: 100px; color: #888;">${date}</div>
                        <div class="order-desc">
                            <div style="font-weight: 500;">${clientName}</div>
                            <div style="font-size: 12px; color: #888;">${o.–û–ø–∏—Å–∞–Ω–∏–µ–ü—Ä–∏—á–∏–Ω—ã–û–±—Ä–∞—â–µ–Ω–∏—è || '–†–µ–º–æ–Ω—Ç'}</div>
                        </div>
                        <div class="order-sum">${sum.toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                `;
            }).join('');
        }

        function filterOrders(q) {
            // Simple filter - would need client names cached for full search
            renderOrders(allOrders, {});
        }

        async function openOrder(refKey) {
            // For now, just show alert with order number
            alert('–û—Ç–∫—Ä—ã—Ç–∏–µ –∑–∞–∫–∞–∑–∞ ' + refKey + ' - –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ');
        }

        // ===== CLIENTS =====
        async function loadClients() {
            try {
                const resp = await fetch('/proxy/odata/Catalog_–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã?$filter=IsFolder eq false&$top=50&$orderby=Description&$format=json');
                const data = await resp.json();
                allClients = data.value || [];
                renderClients(allClients);
            } catch (e) {
                document.getElementById('clients-list').innerHTML = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        function renderClients(clients) {
            const container = document.getElementById('clients-list');
            if (!clients.length) {
                container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</div>';
                return;
            }
            container.innerHTML = clients.map(c => `
                <div class="client-item" onclick="openClient('${c.Ref_Key}')">
                    <div class="client-avatar">${(c.Description || '?')[0]}</div>
                    <div>
                        <div class="client-name">${c.Description || '‚Äî'}</div>
                        <div class="client-info">${c.–í–∏–¥–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ || ''} ${c.–ò–ù–ù ? '‚Ä¢ –ò–ù–ù: ' + c.–ò–ù–ù : ''}</div>
                    </div>
                </div>
            `).join('');
        }

        function filterClients(q) {
            const filtered = allClients.filter(c => (c.Description || '').toLowerCase().includes(q.toLowerCase()));
            renderClients(filtered);
        }

        // ===== CLIENT CARD =====
        async function openClient(refKey) {
            console.log('openClient:', refKey);
            showPage('client');

            // Load client
            const resp = await fetch(`/proxy/odata/Catalog_–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç—ã(guid'${refKey}')?$format=json`);
            currentClient = await resp.json();
            console.log('currentClient:', currentClient);

            document.getElementById('client-title').textContent = currentClient.Description;
            document.getElementById('client-name').textContent = currentClient.–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ–ü–æ–ª–Ω–æ–µ || currentClient.Description;
            document.getElementById('client-type').textContent = currentClient.–í–∏–¥–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ || '–ö–ª–∏–µ–Ω—Ç';
            document.getElementById('client-avatar').textContent = (currentClient.Description || '?')[0];
            document.getElementById('client-inn').textContent = currentClient.–ò–ù–ù || '‚Äî';
            document.getElementById('client-comment').textContent = currentClient.–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π || '‚Äî';

            // Load cars
            loadClientCars();

            // Load orders
            loadClientOrders(refKey);
        }

        async function loadClientCars() {
            const container = document.getElementById('client-cars');
            if (!currentClient) return;

            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                // –ü–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑—ã –∫–ª–∏–µ–Ω—Ç–∞ —Å –∞–≤—Ç–æ–º–æ–±–∏–ª—è–º–∏
                const ordersResp = await fetch(`/proxy/odata/Document_–ó–∞–∫–∞–∑–ù–∞—Ä—è–¥?$filter=–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_Key eq guid'${currentClient.Ref_Key}'&$top=50&$format=json`);
                const ordersData = await ordersResp.json();
                const orders = ordersData.value || [];

                // –°–æ–±–∏—Ä–∞–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–ª—é—á–∏ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—á–Ω—ã—Ö —á–∞—Å—Ç–µ–π
                const carKeys = new Set();
                for (const order of orders) {
                    const carsResp = await fetch(`/proxy/odata/Document_–ó–∞–∫–∞–∑–ù–∞—Ä—è–¥(guid'${order.Ref_Key}')/–ê–≤—Ç–æ–º–æ–±–∏–ª–∏?$format=json`);
                    const carsData = await carsResp.json();
                    (carsData.value || []).forEach(c => {
                        if (c.–ê–≤—Ç–æ–º–æ–±–∏–ª—å_Key && c.–ê–≤—Ç–æ–º–æ–±–∏–ª—å_Key !== '00000000-0000-0000-0000-000000000000') {
                            carKeys.add(c.–ê–≤—Ç–æ–º–æ–±–∏–ª—å_Key);
                        }
                    });
                    if (carKeys.size >= 10) break; // –õ–∏–º–∏—Ç
                }

                if (carKeys.size === 0) {
                    container.innerHTML = '<div style="color: #888; padding: 10px;">–ù–µ—Ç –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π –≤ –∏—Å—Ç–æ—Ä–∏–∏.<br><small>–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–∫–∞–∑–∞ –º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞.</small></div>';
                    currentClientCars = [];
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–æ–±–∏–ª–µ–π
                const filter = [...carKeys].map(k => `Ref_Key eq guid'${k}'`).join(' or ');
                const carsResp = await fetch(`/proxy/odata/Catalog_–ê–≤—Ç–æ–º–æ–±–∏–ª–∏?$filter=${encodeURIComponent(filter)}&$format=json`);
                const carsData = await carsResp.json();
                const cars = carsData.value || [];

                currentClientCars = cars; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –∑–∞–∫–∞–∑–µ

                container.innerHTML = cars.map(c => `
                    <div class="car-item">
                        <div style="margin-right: 10px;">üöó</div>
                        <div>
                            <div style="font-weight: 600;">${c.Description || '‚Äî'}</div>
                            <div style="font-size: 12px; color: #888;">VIN: ${c.VIN || '‚Äî'}</div>
                        </div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '–û—à–∏–±–∫–∞: ' + e.message;
                currentClientCars = [];
            }
        }

        let currentClientCars = [];

        async function loadClientOrders(clientKey) {
            const container = document.getElementById('client-orders');
            try {
                const resp = await fetch(`/proxy/odata/Document_–ó–∞–∫–∞–∑–ù–∞—Ä—è–¥?$filter=–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_Key eq guid'${clientKey}'&$orderby=Date desc&$top=10&$format=json`);
                const data = await resp.json();
                const orders = data.value || [];

                // Stats
                document.getElementById('stat-orders').textContent = orders.length;
                const sum = orders.reduce((s, o) => s + (o.–°—É–º–º–∞–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0) + (o.–°—É–º–º–∞–†–∞–±–æ—Ç–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0), 0);
                document.getElementById('stat-sum').textContent = sum.toLocaleString('ru-RU') + ' ‚ÇΩ';

                if (!orders.length) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">–ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>';
                    return;
                }

                container.innerHTML = orders.map(o => `
                    <div class="order-item">
                        <div class="order-num">‚Ññ${(o.Number || '').trim()}</div>
                        <div class="order-desc">${o.–û–ø–∏—Å–∞–Ω–∏–µ–ü—Ä–∏—á–∏–Ω—ã–û–±—Ä–∞—â–µ–Ω–∏—è || '–†–µ–º–æ–Ω—Ç'}</div>
                        <div class="order-sum">${((o.–°—É–º–º–∞–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—ã–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0) + (o.–°—É–º–º–∞–†–∞–±–æ—Ç–î–æ–∫—É–º–µ–Ω—Ç–∞ || 0)).toLocaleString('ru-RU')} ‚ÇΩ</div>
                    </div>
                `).join('');
            } catch (e) {
                container.innerHTML = '–û—à–∏–±–∫–∞';
            }
        }

        // ===== NEW ORDER =====
        function setupNewOrder() {
            console.log('setupNewOrder, currentClient:', currentClient);

            // Clear
            orderWorks = [];
            orderParts = [];
            document.getElementById('selected-car-key').value = '';
            renderOrderWorks();
            renderOrderParts();
            updateTotals();

            // Set client info
            if (currentClient) {
                document.getElementById('order-client-info').innerHTML = `
                    <div style="font-weight: 600;">${currentClient.Description}</div>
                    <div style="font-size: 12px; color: #888;">${currentClient.–í–∏–¥–ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞ || ''}</div>
                `;
                loadOrderCars();
            }

            // Load dictionaries
            loadDictionaries();
        }

        function loadOrderCars() {
            const container = document.getElementById('order-cars');
            const cars = currentClientCars;

            let html = '';

            if (cars.length) {
                html = cars.map(c => `
                    <div class="car-item" onclick="selectCar(this, '${c.Ref_Key}')">
                        <div style="margin-right: 10px;">üöó</div>
                        <div>
                            <div style="font-weight: 600;">${c.Description || '‚Äî'}</div>
                            <div style="font-size: 12px; color: #888;">VIN: ${c.VIN || '‚Äî'}</div>
                        </div>
                    </div>
                `).join('');
            }

            html += `
                <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee;">
                    <button class="btn btn-secondary" onclick="openCarSelector()">–í—ã–±—Ä–∞—Ç—å –∏–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞</button>
                </div>
            `;

            container.innerHTML = html;
        }

        async function openCarSelector() {
            openModal('car-select');
            const container = document.getElementById('car-select-list');
            container.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

            try {
                const resp = await fetch('/proxy/odata/Catalog_–ê–≤—Ç–æ–º–æ–±–∏–ª–∏?$filter=IsFolder eq false&$top=50&$orderby=Description&$format=json');
                const data = await resp.json();
                const cars = data.value || [];

                container.innerHTML = cars.map(c => `
                    <div class="list-item" onclick="selectCarFromList('${c.Ref_Key}', '${(c.Description || '').replace(/'/g, "\\'")}', '${c.VIN || ''}')">
                        <div style="font-weight: 500;">üöó ${c.Description || '‚Äî'}</div>
                        <div style="font-size: 12px; color: #888;">VIN: ${c.VIN || '‚Äî'}</div>
                    </div>
                `).join('');
            } catch(e) {
                container.innerHTML = '–û—à–∏–±–∫–∞: ' + e.message;
            }
        }

        let allCarsForSelect = [];

        function selectCarFromList(refKey, name, vin) {
            currentClientCars.push({ Ref_Key: refKey, Description: name, VIN: vin });
            loadOrderCars();
            closeModal('car-select');
            setTimeout(() => {
                const items = document.querySelectorAll('#order-cars .car-item');
                if (items.length) {
                    const last = items[items.length - 1];
                    selectCar(last, refKey);
                }
            }, 100);
        }

        async function filterCarSelect(q) {
            if (allCarsForSelect.length === 0) {
                const resp = await fetch('/proxy/odata/Catalog_–ê–≤—Ç–æ–º–æ–±–∏–ª–∏?$filter=IsFolder eq false&$top=100&$orderby=Description&$format=json');
                const data = await resp.json();
                allCarsForSelect = data.value || [];
            }
            const filtered = allCarsForSelect.filter(c =>
                (c.Description || '').toLowerCase().includes(q.toLowerCase()) ||
                (c.VIN || '').toLowerCase().includes(q.toLowerCase())
            );
            const container = document.getElementById('car-select-list');
            container.innerHTML = filtered.slice(0, 30).map(c => `
                <div class="list-item" onclick="selectCarFromList('${c.Ref_Key}', '${(c.Description || '').replace(/'/g, "\\'")}', '${c.VIN || ''}')">
                    <div style="font-weight: 500;">üöó ${c.Description || '‚Äî'}</div>
                    <div style="font-size: 12px; color: #888;">VIN: ${c.VIN || '‚Äî'}</div>
                </div>
            `).join('');
        }

        function selectCar(el, refKey) {
            document.querySelectorAll('#order-cars .car-item').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selected-car-key').value = refKey;
        }

        async function loadDictionaries() {
            // Repair types
            try {
                const resp = await fetch('/proxy/odata/Catalog_–í–∏–¥—ã–†–µ–º–æ–Ω—Ç–∞?$format=json');
                const data = await resp.json();
                const select = document.getElementById('order-repair-type');
                select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' +
                    (data.value || []).map(t => `<option value="${t.Ref_Key}">${t.Description}</option>`).join('');
            } catch (e) {}

            // Workshops
            try {
                const resp = await fetch('/proxy/odata/Catalog_–¶–µ—Ö–∞?$format=json');
                const data = await resp.json();
                const select = document.getElementById('order-workshop');
                select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' +
                    (data.value || []).map(t => `<option value="${t.Ref_Key}">${t.Description}</option>`).join('');
            } catch (e) {}

            // Masters
            try {
                const resp = await fetch('/proxy/odata/Catalog_–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏?$filter=IsFolder eq false&$top=20&$format=json');
                const data = await resp.json();
                const select = document.getElementById('order-master');
                select.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>' +
                    (data.value || []).map(t => `<option value="${t.Ref_Key}">${t.Description}</option>`).join('');
            } catch (e) {}
        }

        // ===== MODALS =====
        function openModal(type) {
            document.getElementById('modal-' + type).classList.add('open');
            if (type === 'works') loadWorks();
            if (type === 'parts') loadParts();
        }

        function closeModal(type) {
            document.getElementById('modal-' + type).classList.remove('open');
        }

        async function loadWorks() {
            const container = document.getElementById('works-list');
            if (allWorks.length === 0) {
                try {
                    const resp = await fetch('/proxy/odata/Catalog_–ê–≤—Ç–æ—Ä–∞–±–æ—Ç—ã?$filter=IsFolder eq false&$top=100&$format=json');
                    const data = await resp.json();
                    allWorks = data.value || [];
                } catch (e) {
                    container.innerHTML = '–û—à–∏–±–∫–∞';
                    return;
                }
            }
            renderWorks(allWorks);
        }

        function renderWorks(works) {
            const container = document.getElementById('works-list');
            container.innerHTML = works.slice(0, 50).map(w => `
                <div class="list-item" onclick="addWork('${w.Ref_Key}', '${(w.Description || '').replace(/'/g, "\\'")}')">
                    <div style="font-weight: 500;">üîß ${w.Description || '‚Äî'}</div>
                    <div style="font-size: 12px; color: #888;">–í—Ä–µ–º—è: ${w.–í—Ä–µ–º—è–í—ã–ø–æ–ª–Ω–µ–Ω–∏—è || 0} –º–∏–Ω</div>
                </div>
            `).join('');
        }

        function filterWorks(q) {
            const filtered = allWorks.filter(w => (w.Description || '').toLowerCase().includes(q.toLowerCase()));
            renderWorks(filtered);
        }

        function addWork(refKey, name) {
            orderWorks.push({ refKey, name, qty: 1, price: 0 });
            renderOrderWorks();
            updateTotals();
            closeModal('works');
        }

        function renderOrderWorks() {
            const tbody = document.getElementById('works-table');
            if (!orderWorks.length) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #888;">–î–æ–±–∞–≤—å—Ç–µ —Ä–∞–±–æ—Ç—ã</td></tr>';
                return;
            }
            tbody.innerHTML = orderWorks.map((w, i) => `
                <tr>
                    <td>${i + 1}</td>
                    <td>${w.name}</td>
                    <td><input type="number" value="${w.qty}" min="1" style="width:60px;padding:5px;" onchange="updateWork(${i}, 'qty', this.value)"></td>
                    <td><input type="number" value="${w.price}" min="0" style="width:80px;padding:5px;" onchange="updateWork(${i}, 'price', this.value)"></td>
                    <td>${(w.qty * w.price).toLocaleString('ru-RU')} ‚ÇΩ</td>
                    <td><button onclick="removeWork(${i})" style="border:none;background:none;color:#f44336;cursor:pointer;">‚úï</button></td>
                </tr>
            `).join('');
        }

        function updateWork(i, field, val) {
            orderWorks[i][field] = parseFloat(val) || 0;
            renderOrderWorks();
            updateTotals();
        }

        function removeWork(i) {
            orderWorks.splice(i, 1);
            renderOrderWorks();
            updateTotals();
        }

        // Parts
        async function loadParts() {
            const container = document.getElementById('parts-list');
            if (allParts.length === 0) {
                try {
                    const resp = await fetch('/proxy/odata/Catalog_–ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞?$filter=IsFolder eq false&$top=100&$format=json');
                    const data = await resp.json();
                    allParts = data.value || [];
                } catch (e) {
                    container.innerHTML = '–û—à–∏–±–∫–∞';
                    return;
                }
            }
            renderParts(allParts);
        }

        function renderParts(parts) {
            const container = document.getElementById('parts-list');
            container.innerHTML = parts.slice(0, 50).map(p => `
                <div class="list-item" onclick="addPart('${p.Ref_Key}', '${(p.Description || '').replace(/'/g, "\\'")}')">
                    <div style="font-weight: 500;">üì¶ ${p.Description || '‚Äî'}</div>
                    <div style="font-size: 12px; color: #888;">–ê—Ä—Ç–∏–∫—É–ª: ${p.–ê—Ä—Ç–∏–∫—É–ª || '‚Äî'}</div>
                </div>
            `).join('');
        }

        function filterParts(q) {
            const filtered = allParts.filter(p =>
                (p.Description || '').toLowerCase().includes(q.toLowerCase()) ||
                (p.–ê—Ä—Ç–∏–∫—É–ª || '').toLowerCase().includes(q.toLowerCase())
            );
            renderParts(filtered);
        }

        function addPart(refKey, name) {
            orderParts.push({ refKey, name, qty: 1, price: 0, discount: 0 });
            renderOrderParts();
            updateTotals();
            closeModal('parts');
        }

        function renderOrderParts() {
            const tbody = document.getElementById('parts-table');
            if (!orderParts.length) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø—á–∞—Å—Ç–∏</td></tr>';
                return;
            }
            tbody.innerHTML = orderParts.map((p, i) => {
                const sum = p.qty * p.price * (1 - p.discount / 100);
                return `
                    <tr>
                        <td>${i + 1}</td>
                        <td>${p.name}</td>
                        <td><input type="number" value="${p.qty}" min="1" style="width:60px;padding:5px;" onchange="updatePart(${i}, 'qty', this.value)"></td>
                        <td><input type="number" value="${p.price}" min="0" style="width:80px;padding:5px;" onchange="updatePart(${i}, 'price', this.value)"></td>
                        <td><input type="number" value="${p.discount}" min="0" max="100" style="width:60px;padding:5px;" onchange="updatePart(${i}, 'discount', this.value)">%</td>
                        <td>${sum.toLocaleString('ru-RU')} ‚ÇΩ</td>
                        <td><button onclick="removePart(${i})" style="border:none;background:none;color:#f44336;cursor:pointer;">‚úï</button></td>
                    </tr>
                `;
            }).join('');
        }

        function updatePart(i, field, val) {
            orderParts[i][field] = parseFloat(val) || 0;
            renderOrderParts();
            updateTotals();
        }

        function removePart(i) {
            orderParts.splice(i, 1);
            renderOrderParts();
            updateTotals();
        }

        // Totals
        function updateTotals() {
            const worksSum = orderWorks.reduce((s, w) => s + w.qty * w.price, 0);
            const partsSum = orderParts.reduce((s, p) => s + p.qty * p.price, 0);
            const discountSum = orderParts.reduce((s, p) => s + p.qty * p.price * p.discount / 100, 0);
            const total = worksSum + partsSum - discountSum;

            document.getElementById('works-sum').textContent = worksSum.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('parts-sum').textContent = (partsSum - discountSum).toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('total-works').textContent = worksSum.toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('total-parts').textContent = (partsSum - discountSum).toLocaleString('ru-RU') + ' ‚ÇΩ';
            document.getElementById('total-sum').textContent = total.toLocaleString('ru-RU') + ' ‚ÇΩ';
        }

        // Save
        async function saveOrder() {
            if (!currentClient) {
                alert('–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞');
                return;
            }

            try {
                const orgResp = await fetch('/proxy/odata/Catalog_–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏?$top=1&$format=json');
                const org = (await orgResp.json()).value?.[0];

                const valResp = await fetch('/proxy/odata/Catalog_–í–∞–ª—é—Ç—ã?$top=1&$format=json');
                const val = (await valResp.json()).value?.[0];

                const carKey = document.getElementById('selected-car-key').value;

                const orderData = {
                    Date: new Date().toISOString(),
                    –ö–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç_Key: currentClient.Ref_Key,
                    –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è_Key: org?.Ref_Key,
                    –í–∞–ª—é—Ç–∞–î–æ–∫—É–º–µ–Ω—Ç–∞_Key: val?.Ref_Key,
                    –í–∏–¥–†–µ–º–æ–Ω—Ç–∞_Key: document.getElementById('order-repair-type').value || undefined,
                    –¶–µ—Ö_Key: document.getElementById('order-workshop').value || undefined,
                    –ü—Ä–æ–±–µ–≥: document.getElementById('order-mileage').value || "0",
                    –û–ø–∏—Å–∞–Ω–∏–µ–ü—Ä–∏—á–∏–Ω—ã–û–±—Ä–∞—â–µ–Ω–∏—è: document.getElementById('order-reason').value || "–†–µ–º–æ–Ω—Ç",
                    –ê–≤—Ç–æ–º–æ–±–∏–ª–∏: carKey ? [{ –ê–≤—Ç–æ–º–æ–±–∏–ª—å_Key: carKey }] : [],
                    –ê–≤—Ç–æ—Ä–∞–±–æ—Ç—ã: orderWorks.map(w => ({
                        –ê–≤—Ç–æ—Ä–∞–±–æ—Ç–∞_Key: w.refKey,
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: w.qty,
                        –¶–µ–Ω–∞: w.price,
                        –°—É–º–º–∞: w.qty * w.price
                    })),
                    –¢–æ–≤–∞—Ä—ã: orderParts.map(p => ({
                        –ù–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–∞_Key: p.refKey,
                        –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: p.qty,
                        –¶–µ–Ω–∞: p.price,
                        –°—É–º–º–∞: p.qty * p.price * (1 - p.discount / 100),
                        –ü—Ä–æ—Ü–µ–Ω—Ç–°–∫–∏–¥–∫–∏: p.discount
                    }))
                };

                console.log('Saving order:', orderData);

                const resp = await fetch('/proxy/odata/Document_–ó–∞–∫–∞–∑–ù–∞—Ä—è–¥?$format=json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(orderData)
                });

                if (!resp.ok) {
                    const err = await resp.text();
                    throw new Error(err);
                }

                const result = await resp.json();
                alert('‚úÖ –ó–∞–∫–∞–∑ —Å–æ–∑–¥–∞–Ω: ‚Ññ' + (result.Number || '').trim());
                showPage('client');
                loadClientOrders(currentClient.Ref_Key);

            } catch (e) {
                alert('‚ùå –û—à–∏–±–∫–∞: ' + e.message);
                console.error(e);
            }
        }

        // ===== INIT =====
        loadOrders();
        loadClients();
    </script>
</body>
</html>
